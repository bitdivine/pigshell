Running a local instance of _pigshell_
======================================

[_Pigshell_](http://bitdivine.com) is a pure client-side Javascript app running
in the browser, which presents resources on the web as files.  These include
public web pages as well as private data in Google Drive, Dropbox, Facebook and
even your desktop.

All authentication (username, password) and data (documents, photos) traffic is
directly between the user's browser and the cloud store (Google Drive, Dropbox)
The [_pigshell_](http://bitdivine.com) server is a dumb static file server. It
plays no part in data movement. This ensures complete privacy of user data.

However, you may still wish to run a local instance of pigshell for the
following reasons:

1.  You want to modify the code.
2.  You want an local instance running inside your organization.
3.  You want to make sure that the code you are running is really the
    _pigshell_ from git, without any surreptitious modifications.

This document describes how to set up a local instance of bitdivine.com to serve
HTML, JS and other static assets. It is aimed at developers and is geared
towards a fast "Edit code/Hit Reload" workflow.

This is not to be confused with [_psty_](http://bitdivine.com/v/0.6.2/doc/psty.html), which is a local file and proxy server.

The instructions below apply to Mac OS X, but should work on Linux.

Prerequisites
=============

1.  **apache2**. Anything capable of serving static web pages will work, but it
    must run on port 80. An apache config file is automatically produced by
    `make`.

2.  **nodejs** (at least v0.10) and **npm**. The installation of these is
    very OS and distribution-specific. Google is your friend.

3.  [PEG.js](http://pegjs.majda.cz/). You must git clone [this exact version](https://github.com/ganeshv/pegjs) and update PATH so it points to pegjs/bin.
    Newer or older versions won't work.

4.  [marked](https://github.com/chjj/marked) version 0.2.5 or newer.

5.  [ronn](https://github.com/rtomayko/ronn) version 0.7.3 or newer.

6.  [jshint](https://github.com/jshint/jshint/) version 2.5.0 or newer.

7.  Clone the [pigshell](https://github.com/pigshell/pigshell) repository.

For a really minimal install, you can get away without installing any of the
pre-requisites. You can get a
[pre-built parser](https://gist.github.com/ganeshv/62b59e9d0a4ab2192129) to
avoid installing pegjs, and copy the `pigpeg.js` file from the gist inside
the `build` directory.

Compilation
===========

Run `make` inside the _pigshell_ directory.

If you have not installed some of the dependencies above, you may have to
run `make -i` to ignore errors.

Setup
=====

An Apache configuration file is generated by `make` as `etc/httpd-vhosts.conf`

You need to copy this file to `/etc/apache2` and make sure it gets included in
your Apache configuration. The generated file is perfect for the installation
of Apache included in Mac OS X Mountain Lion. You need to edit httpd.conf and
uncomment/edit the following line to include this file:

    Include /private/etc/apache2/httpd-vhosts.conf

On other operating systems, the above steps may vary.

See the comments at the top of the file for other changes you need to make to
your Apache setup.

You need to update this file and restart Apache every time the Pigshell
version tag changes.

Edit `/etc/hosts` and add the line

    127.0.0.1 bitdivine.com

That's pretty much it!

Usage
=====

Visit http://bitdivine.com - your browser should now retrieve your own copy of
_pigshell_. All filesystems except Dropbox should work.

After editing code inside the _pigshell_ directory, run `make` and hit reload.
You should see the results of the changed code. In some browsers, you may need
to hold down the Shift key while reloading to bypass the cache.

Running the `uname -a` command inside _pigshell_ gives a string like

    Pigshell 0.6.3-pre5 9f368b051ed8fcf1b8f11ff24597b0d98fcb0f2d

The last string is the latest git commit id at the time of `make`.

Advanced
========

Dropbox requires that the redirect URL be https. The generated apache config
file contains a commented section indicating what needs to be done. Details
of running an https server and generating a self-signed certificate are beyond
the scope of this document.

Common Issues
=============

You get an error immediately on loading, like this:

    Parse error in line:undefined col:undefined "undefined"
    parser is undefined

This is due to a missing parser. Pegjs may not be present, or not working due
to missing or old node installation. You should use the pigpeg.js file from the
pre-built parser gist mentioned above. `make clean` deletes the parser
from the build directory, so if you are using the pre-built file, you will need
to copy it in after every `make clean`.
